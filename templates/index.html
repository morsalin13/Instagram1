<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Instagram Username Checker</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:900px;margin:0 auto;padding:20px;background:#0f1115;color:#e4e6eb}
    .box{background:#18191a;border:1px solid #2a2b2e;border-radius:10px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.35)}
    h1{text-align:center;margin:0 0 10px}
    textarea,input{width:100%;padding:10px;margin:8px 0;background:#242526;border:1px solid #3a3b3c;border-radius:6px;color:#e4e6eb}
    textarea{height:140px;resize:vertical}
    button{width:100%;padding:10px;border:0;border-radius:6px;font-weight:700;cursor:pointer;background:#0095f6;color:#fff}
    button:disabled{background:#555;cursor:not-allowed}
    .row{display:flex;gap:10px}
    .row button{width:50%}
    .note{color:#b0b3b8;font-size:13px;line-height:1.4}
    .ok{background:#1e4620;border:1px solid #2b6a33;padding:10px;border-radius:8px;margin:10px 0}
    .warn{background:#3b2f00;border:1px solid #6a5b16;padding:10px;border-radius:8px;margin:10px 0}
    .err{color:#ff6b6b}
    .result-item{border-bottom:1px solid #2a2b2e;padding:10px 0;display:flex;justify-content:space-between}
    .taken{color:#ed4956;font-weight:700}
    .avail{color:#2ecc71;font-weight:700}
    .tag{font-size:12px;background:#333;padding:2px 6px;border-radius:4px;margin-left:6px}
    .stats{margin-top:10px;text-align:right;color:#b0b3b8;font-size:13px}
  </style>
</head>
<body>
  <div class="box">
    <h1>Instagram Username Checker</h1>

    {% if connected %}
      <div class="ok">
        ✅ Connected (Cookies saved for this visitor)
        <div class="note">If it stops working later, reconnect cookies.</div>
        <button style="background:#ed4956;margin-top:10px" onclick="disconnect()">Disconnect</button>
      </div>
    {% else %}
      <div class="warn">
        <b>Step 1:</b> Click “Login with Instagram” and login in the real Instagram page.<br/>
        <b>Step 2:</b> After login, copy your Instagram cookies and paste here to connect.
        <div class="note" style="margin-top:8px">
          Tip: This method reduces checkpoint because login happens on instagram.com directly.
        </div>
        <div class="row" style="margin-top:10px">
          <button onclick="openInstagramLogin()">Login with Instagram</button>
          <button style="background:#6c757d" onclick="showHow()">How to copy cookies</button>
        </div>

        <div id="howBox" class="note" style="display:none;margin-top:10px">
          Open instagram.com after login → Browser DevTools → Application/Storage → Cookies → instagram.com → copy cookies as a single line like:<br/>
          <code>sessionid=...; csrftoken=...; ds_user_id=...;</code><br/>
          Then paste below and click Connect.
        </div>

        <textarea id="cookieText" placeholder="Paste cookie header here: sessionid=...; csrftoken=...; ds_user_id=...;"></textarea>
        <button id="connectBtn" onclick="connectCookies()">Connect</button>
        <div id="connectStatus" class="note" style="margin-top:8px"></div>
      </div>
    {% endif %}

    <h3>Check Usernames</h3>
    <div class="note">Enter usernames (one per line). Login/Connect is required for deep scan (UID + Followers).</div>
    <textarea id="usernamesInput" placeholder="username1&#10;username2"></textarea>
    <button id="checkBtn" onclick="checkUsernames()" {% if not connected %}disabled{% endif %}>Check Availability</button>

    <div id="results"></div>
  </div>

<script>
function openInstagramLogin(){
  window.open("https://www.instagram.com/accounts/login/", "_blank");
}
function showHow(){
  const b = document.getElementById("howBox");
  b.style.display = (b.style.display === "none") ? "block" : "none";
}
async function connectCookies(){
  const cookie_text = document.getElementById("cookieText").value.trim();
  const btn = document.getElementById("connectBtn");
  const st = document.getElementById("connectStatus");

  if(!cookie_text){
    st.innerHTML = '<span class="err">Paste cookies first.</span>';
    return;
  }

  btn.disabled = true;
  btn.innerText = "Connecting...";
  st.innerHTML = "";

  try{
    const res = await fetch("/connect_cookies",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({cookie_text})
    });
    const data = await res.json();
    if(data.success){
      st.innerHTML = "✅ " + data.message + " Reloading...";
      setTimeout(()=>location.reload(), 800);
    }else{
      st.innerHTML = '<span class="err">❌ ' + data.message + "</span>";
      btn.disabled = false;
      btn.innerText = "Connect";
    }
  }catch(e){
    st.innerHTML = '<span class="err">❌ ' + e.message + "</span>";
    btn.disabled = false;
    btn.innerText = "Connect";
  }
}

async function disconnect(){
  await fetch("/disconnect",{method:"POST"});
  location.reload();
}

async function checkUsernames(){
  const names = document.getElementById("usernamesInput").value.split("\n").map(x=>x.trim()).filter(Boolean);
  if(!names.length) return alert("Enter usernames");

  const btn = document.getElementById("checkBtn");
  const results = document.getElementById("results");
  btn.disabled = true;
  btn.innerText = "Checking...";
  results.innerHTML = "<p class='note'>Processing...</p>";

  try{
    const res = await fetch("/check",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({usernames:names})
    });

    if(res.status === 401){
      alert("Not connected. Please login & connect cookies first.");
      location.reload();
      return;
    }

    const data = await res.json();
    let html = "<h3>Results:</h3>";
    let a=0,t=0;

    data.forEach(i=>{
      if(i.status==="Available") a++;
      if(i.status==="Taken") t++;

      const cls = (i.status==="Taken") ? "taken" : (i.status==="Available") ? "avail" : "";
      html += `
        <div class="result-item">
          <div>
            <div style="font-weight:700;font-size:16px">${i.username}</div>
            ${i.followers !== undefined ? `<div class="note">Followers: <b>${i.followers}</b> · UID: <b>${i.uid}</b></div>` : ""}
          </div>
          <div style="text-align:right">
            <div class="${cls}">${i.status}</div>
            <div class="note">${i.details || ""}</div>
            <span class="tag">${i.method || "?"}</span>
          </div>
        </div>
      `;
    });

    html += `<div class="stats">Total: ${data.length} | Available: ${a} | Taken: ${t}</div>`;
    results.innerHTML = html;

  }catch(e){
    results.innerHTML = `<p class="err">Error: ${e.message}</p>`;
  }finally{
    btn.disabled = false;
    btn.innerText = "Check Availability";
  }
}
</script>
</body>
</html>
